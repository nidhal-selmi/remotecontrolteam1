name: DCF Merge Review

on:
  push:
    branches:
      - main

jobs:
  trigger-dcf:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Decision Capture Framework
        env:
          DCF_API_URL: ${{ secrets.DCF_API_URL }}
          DCF_CI_TOKEN: ${{ secrets.DCF_CI_TOKEN }}
          BASE_REF: ${{ github.event.before }}
          HEAD_REF: ${{ github.sha }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          SHA_SHORT: ${{ github.sha }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ -z "${DCF_API_URL:-}" || -z "${DCF_CI_TOKEN:-}" ]]; then
            echo "Missing DCF_API_URL or DCF_CI_TOKEN GitHub secret."
            exit 1
          fi

          if [[ "${BASE_REF}" =~ ^0+$ ]]; then
            echo "Initial push detected (no valid base_ref). Skipping DCF trigger."
            echo "## Decision Capture Review" >> "${GITHUB_STEP_SUMMARY}"
            echo "- Trigger skipped on initial push (base_ref is all zeros)." >> "${GITHUB_STEP_SUMMARY}"
            exit 0
          fi

          MERGE_REF="${SHA_SHORT:0:12}"
          RESPONSE_FILE="$(mktemp)"

          curl -sS -X POST "${DCF_API_URL}/ci/merge" \
            -H "Content-Type: application/json" \
            -H "X-DCF-Token: ${DCF_CI_TOKEN}" \
            -d "$(cat <<JSON
          {
            "base_ref": "${BASE_REF}",
            "head_ref": "${HEAD_REF}",
            "merge_ref": "${MERGE_REF}",
            "metadata": {
              "repository": "${REPO}",
              "github_run_id": "${RUN_ID}",
              "trigger": "github_actions_push_main"
            }
          }
JSON
          )" > "${RESPONSE_FILE}"

          python - <<'PY' "${RESPONSE_FILE}" "${DCF_API_URL}"
import json
import sys
from pathlib import Path

payload = json.loads(Path(sys.argv[1]).read_text(encoding="utf-8"))
api_url = sys.argv[2].rstrip("/")
run_id = payload.get("run_id", "")
review_url = payload.get("review_url") or (f"{api_url}/reviews/{run_id}" if run_id else "")
status = payload.get("status", payload.get("run_type", "unknown"))

summary = [
    "## Decision Capture Review",
    "",
    f"- Trigger status: `{status}`",
    f"- Run ID: `{run_id}`",
    f"- Review URL: {review_url}" if review_url else "- Review URL: (not returned)",
]
Path(Path.cwd() / ".dcf-summary.txt").write_text("\n".join(summary) + "\n", encoding="utf-8")
print(json.dumps(payload, indent=2))
PY

          cat .dcf-summary.txt >> "${GITHUB_STEP_SUMMARY}"
